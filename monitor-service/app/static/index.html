<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monitor UI - Microservices</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body { 
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #1e293b;
        min-height: 100vh;
      }

      header { 
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 20px 32px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      header h1 { 
        color: white; 
        font-size: 28px; 
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .container { 
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px 24px; 
      }

      .status-overview {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 20px;
        border-radius: 24px;
        font-weight: 600;
        font-size: 14px;
        animation: fadeIn 0.3s ease;
      }

      .status-badge.healthy {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
      }

      .status-badge.degraded {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
      }

      .status-badge.down {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: white;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
      }

      .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      }

      .card h3 {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 16px;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .card-icon {
        font-size: 24px;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .metric-box {
        background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
        padding: 16px;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
      }

      .metric-box:hover {
        background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
        transform: scale(1.05);
      }

      .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: #667eea;
        display: block;
        margin-bottom: 4px;
      }

      .metric-label {
        font-size: 12px;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 8px;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      pre {
        background: #1e293b;
        color: #e2e8f0;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.6;
        margin-top: 12px;
      }

      .result-box {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        margin-top: 12px;
        font-size: 13px;
        min-height: 60px;
      }

      footer {
        text-align: center;
        padding: 20px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 13px;
      }

      .refresh-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 12px;
        color: white;
      }

      .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .toast {
        position: fixed;
        top: 24px;
        right: 24px;
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        display: none;
        align-items: center;
        gap: 12px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from { transform: translateX(400px); }
        to { transform: translateX(0); }
      }

      .toast.success { border-left: 4px solid #10b981; }
      .toast.error { border-left: 4px solid #ef4444; }

      @media (max-width: 768px) {
        .grid { grid-template-columns: 1fr; }
        .form-row { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <header>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>üöÄ Monitor - Microservices</h1>
        <div class="refresh-indicator">
          <div class="spinner"></div>
          <span id="nextRefresh">5s</span>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="status-overview">
        <div class="status-header">
          <h2 style="font-size: 24px;">Estado del Sistema</h2>
          <div class="status-badge healthy" id="overallBadge">
            <div class="status-indicator"></div>
            <span id="overall">Cargando...</span>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <h3><span class="card-icon">üì§</span> Producer</h3>
            <div id="producerMetrics" class="metrics-grid"></div>
            <pre id="producer-detail" style="max-height: 200px;">Cargando...</pre>
          </div>

          <div class="card">
            <h3><span class="card-icon">üê∞</span> RabbitMQ</h3>
            <div class="metrics-grid">
              <div class="metric-box">
                <span class="metric-value" id="queue_messages">-</span>
                <span class="metric-label">Mensajes</span>
              </div>
              <div class="metric-box">
                <span class="metric-value" id="queue_consumers">-</span>
                <span class="metric-label">Consumidores</span>
              </div>
            </div>
            <pre id="rabbit-detail" style="max-height: 200px;">Cargando...</pre>
          </div>
        </div>

        <div class="card">
          <h3><span class="card-icon">üìä</span> M√©tricas Prometheus</h3>
          <pre id="metrics" style="max-height: 300px;">Cargando...</pre>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3><span class="card-icon">‚úâÔ∏è</span> Enviar Mensaje</h3>
          <form id="sendForm">
            <div class="form-group">
              <label>Shipment ID</label>
              <input type="text" id="shipmentId" value="SHP-UI" required />
            </div>
            <div class="form-group">
              <label>Status</label>
              <input type="text" id="status" value="in_transit" required />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Latitud</label>
                <input type="number" id="lat" step="0.0001" value="-12.0" required />
              </div>
              <div class="form-group">
                <label>Longitud</label>
                <input type="number" id="lng" step="0.0001" value="-77.0" required />
              </div>
            </div>
            <button type="submit">üöÄ Enviar Mensaje</button>
          </form>
          <div class="result-box" id="sendResult">Esperando env√≠o...</div>
        </div>

        <div class="card">
          <h3><span class="card-icon">üì¶</span> Enviar Lote</h3>
          <form id="batchForm">
            <div class="form-group">
              <label>Cantidad de mensajes</label>
              <input type="number" id="batchCount" value="5" min="1" max="100" required />
            </div>
            <div class="form-group">
              <label>Base Shipment ID</label>
              <input type="text" id="batchBase" value="SHP-BATCH" required />
            </div>
            <button type="submit">üì§ Enviar Lote</button>
          </form>
          <div class="result-box" id="batchResult">Esperando env√≠o...</div>
        </div>
      </div>
    </div>

    <footer>
      <div>√öltima actualizaci√≥n: <span id="updated">-</span></div>
    </footer>

    <div class="toast" id="toast">
      <span id="toastMessage"></span>
    </div>

    <script>
      let refreshCountdown = 5;

      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        toastMessage.textContent = message;
        toast.className = `toast ${type}`;
        toast.style.display = 'flex';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
      }

      function updateStatusBadge(status) {
        const badge = document.getElementById('overallBadge');
        badge.className = 'status-badge';
        if (status === 'healthy' || status === 'ok') {
          badge.classList.add('healthy');
        } else if (status === 'degraded') {
          badge.classList.add('degraded');
        } else {
          badge.classList.add('down');
        }
      }

      async function fetchData() {
        try {
          const h = await fetch('/health');
          const sj = await h.json();
          
          document.getElementById('overall').textContent = sj.status || 'unknown';
          updateStatusBadge(sj.status);
          
          const producer = sj.producer || {};
          const rabbit = sj.rabbitmq || {};
          
          document.getElementById('producer-detail').textContent = JSON.stringify(producer, null, 2);
          document.getElementById('rabbit-detail').textContent = JSON.stringify(rabbit, null, 2);
          document.getElementById('queue_messages').textContent = rabbit.message_count ?? '-';
          document.getElementById('queue_consumers').textContent = rabbit.consumer_count ?? '-';

        } catch (e) {
          document.getElementById('overall').textContent = 'error';
          updateStatusBadge('down');
          document.getElementById('producer-detail').textContent = 'Error: ' + e.message;
        }

        try {
          const m = await fetch('/metrics');
          const text = await m.text();
          document.getElementById('metrics').textContent = text;
        } catch (e) {
          document.getElementById('metrics').textContent = 'Error: ' + e.message;
        }

        document.getElementById('updated').textContent = new Date().toLocaleString('es-ES');
        refreshCountdown = 5;
      }

      fetchData();
      setInterval(fetchData, 5000);
      
      setInterval(() => {
        refreshCountdown--;
        if (refreshCountdown < 0) refreshCountdown = 5;
        document.getElementById('nextRefresh').textContent = refreshCountdown + 's';
      }, 1000);

      document.getElementById('sendForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const shipmentId = document.getElementById('shipmentId').value;
        const status = document.getElementById('status').value;
        const lat = parseFloat(document.getElementById('lat').value);
        const lng = parseFloat(document.getElementById('lng').value);

        const body = { 
          shipmentId, 
          status, 
          timestamp: new Date().toISOString(), 
          location: { lat, lng } 
        };
        
        document.getElementById('sendResult').textContent = '‚è≥ Enviando...';
        
        try {
          const r = await fetch('/api/send', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(body) 
          });
          const j = await r.json();
          document.getElementById('sendResult').textContent = JSON.stringify(j, null, 2);
          showToast('‚úì Mensaje enviado correctamente', 'success');
        } catch (err) {
          document.getElementById('sendResult').textContent = '‚ùå Error: ' + err.message;
          showToast('‚úó Error al enviar mensaje', 'error');
        }
      });

      document.getElementById('batchForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const count = parseInt(document.getElementById('batchCount').value, 10) || 1;
        const base = document.getElementById('batchBase').value || 'SHP-BATCH';
        const msg = { shipmentId: base, status: 'pending' };
        
        document.getElementById('batchResult').textContent = '‚è≥ Enviando lote...';
        
        try {
          const r = await fetch('/api/send_batch', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ count, message: msg }) 
          });
          const j = await r.json();
          document.getElementById('batchResult').textContent = JSON.stringify(j, null, 2);
          showToast(`‚úì Lote de ${count} mensajes enviado`, 'success');
        } catch (err) {
          document.getElementById('batchResult').textContent = '‚ùå Error: ' + err.message;
          showToast('‚úó Error al enviar lote', 'error');
        }
      });
    </script>
  </body>
</html>